# LXC

## lxc란?

linux container(lxc)는 사용자영역 컨테이너 개체를 제공하여 새로운 기능을 사용하게 한다.
이 새로운 기능은 응용 프로그램이나 시스템에서 모든 자원의 격리와 제어를 제공한다.

컨테이너를 간단한 명령어를 통해 쉽게 관리할 수 있고, 다목적으로 사용될 수 있다.

컨테이너는 응용프로그램이나 시스템을 컨테이너 내부에서 실행시키기 위해 호스트의 몇몇 자원을 격리시키는 객체이다.
어플리케이션/시스템은 처음 생성될 때 혹은 시작 명령어의 인자로 넘겨주었던 설정을 기반으로 한 컨테이너 안에서 실행된다.


### 컨테이너의 실행

#### 어떻게 컨테이너 내부에서 응용프로그램을 실행할까?

실행하기 전, 고립시키려는 자원을 알아야 한다. 기본적으로 pid, sysv, ipc, 마운트 포인트들을 고립시킨다.

만약 쉘을 컨테이너 내부에서 실행시키려면 간단한 설정을 하면 되고, sshd같은 응용프로그램을 실행시키려면 네트워크 스택과 호스트 네임을 제공해주어야 한다.

그리고 만약 /var/run/httpd.pid의 충돌을 피하려면 /var/run을 빈 디렉토리로 다시 마운트하는것이 필요하다. 모든 파일 충돌을 피하려면 컨테이너의 루트 파일시스템을 따로 지정해주면 된다. 따라서 컨테이너의 루트 파일시스템은 원래의 루트 파일시스템을 바인드 마운트한 디렉토리가 될 수 있다. 이렇게 자신만의 /etc, /home을 사용하면서 배포판을 그대로 사용할 수 있다.

#### 그렇다면 어떻게 컨테이너 내부에서 시스템을 실행할까?

시스템을 실행시키는 것은 응용프로그램을 실행하는 것보다 쉽다. 어떤자원이 고립되어야 하는지 고려할 필요 없이 모든 자원을 고립시키면 되기 때문이다. 자원들은 설정 없이 고립된다고 지정만 하면 컨테이너가 자원들을 세팅할 것이다. 예를들어 ipv4주소는 시스템 컨테이너의 init 스크립트를 통해 세팅된다.



### 컨테이너의 생명주기

컨테이너 생성될 때, 컨테이너는 설정정보를 포함한다. 프로세스가 실행될때 컨테이너는 시작되고 실행된다. 컨테이너 내에서 실행되던 마지막 프로세스가 종료되면, 컨테이너는 종료된다. 컨테이너 초기화가 실패했을 경우, Aborting상태가된다.

```
  ---------
  | STOPPED |<---------------
   ---------                 |
       |                     |
     start                   |
       |                     |
       V                     |
   ----------                |
  | STARTING |--error-       |
   ----------         |      |
       |              |      |
       V              V      |
   ---------    ----------   |
  | RUNNING |  | ABORTING |  |
   ---------    ----------   |
       |              |      |
  no process          |      |
       |              |      |
       V              |      |
   ----------         |      |
  | STOPPING |<-------       |
   ----------                |
       |                     |
        ---------------------
```



### 컨테이너 설정

컨테이너는 lxc.conf 파일에 의해 설정된다. 

lxc 설정파일은 컨테이너 설정과 시스템 설정 두 부분으로 나뉜다.

- 컨테이너 설정은 컨테이너 디렉토리의 config로 설정한다. 기본 설정은 컨테이너 생성 시 템플릿이 제공하는 설정과 default.conf파일에 있는 추가 설정들로 생성된다. default.conf파일은 /etc/lxc/default.conf에 위치한다.

- 시스템 설정은 /etc/lxc/lxc.conf에 위치한다. 이 설정파일엔 lxc기본 경로 및 저장소 백엔드 설정과 같은 값들을 설정할 때 사용한다.  이 파일엔 다음과 같은 내용이 있다.

  * **경로 설정** : lxc.lxcpath와 lxc.default_config

    lxc.lxcpath는 모든 컨테이너들이 저장되는 장소의 경로이고, lxc.default_config는 컨테이너의 기본 설정파일의 경로이다. 

  * **컨트롤 그룹** : lxc.cgroup.use와 lxc.cgroup.pattern

    사용할 cgroup 컨트롤러의 목록과 컨테이너용 cgroup을 생성할 때 사용하는 포맷 문자열이다.

  * **LVM** : lxc.bdev.lvm.vg와 lxc.bdev.lvm.thin_pool

    기본 LVM볼륨 그룹이름과 기본 LVM thin pool이름

  * **ZFS** : lxc.bdev.zfs.root

    기본 ZFS root 이름



### 컨테이너의 생성/ 제거 

#### 지속 컨테이너

지속성 컨테이너 객체는 lxc-create명령어로 생성된다.  컨테이너 이름을 인수로 받고 부가적인 설정파일과 템플릿을 지정한다. 컨테이너는 이름으로 식별되기 때문에 이름이 중복되면 안된다. lxc-destroy 명령어는 컨테이너 객체를 제거한다.

#### 휘발성 컨테이너

컨테이너 시작 전에 컨테이너 꼭 오브젝트를 생성하지 않아도 된다. 컨테이너는 설정파일을 파라미터로 넣어서 바로 시작할 수도 있다.



### 컨테이너의 시작과 종료

컨테이너가 생성되면 응용 프로그램/시스템이  실행될 준비를 마친 것이다. lxc-execute와 lxc-start 명령어로 실행한다.

응용프로그램 시작 전에 컨테이너가 생성되어 있지 않다면, 컨테이너는 명령어의 인수로 넘겼던 설정파일을 사용한다. 그런 인수마저 없다면 기본 고립 환경을 사용한다. 만약 응용프로그램이 종료되면 컨테이너도 역시 종료된다. 응용프로그램을 종료시키려면 lxc-stop을 사용하면 된다.

#### lxc-execute와 lxc-start의 차이점은?

컨테이너 내부에서 응용프로그램을 실행하는것과 시스템을 실행하는것은 차이가 있다.

lxc-execute는 컨테이너 내부에서 lxc-init프로세스를 통해 실행할 명령어를 지정할 수 있다. lxc-init은 지정한 명령어를 우선 실행하고 그명령어로 실행된 모든 프로세스가 종료되길 기다린다.(컨테이너 내부에서 데몬을 지원하기 위해) 다시말해 컨테이너 내부에서 lxc-init이 1번 pid를 갖고, 응용프로그램이 2번 pid부터 갖게 된다.



반면 lxc-start는 지정한 명령어를 컨테이너 내에서 직접 실행한다. 첫 프로세스의 pid는 1번이다.  만약 명령어가 지정되어있지 않다면 lxc.init.cmd에 지정된 명령어를 실행하고 여기도 지정된 명령이 없다면 /sbin/init을 실행한다.

**요약하면 lxc-execute는 응용 프로그램 실행에, lxc-start는 시스템 실행에 적합하다.**



### 사용 가능한 TTY(일반 CLI콘솔) 접속

컨테이너에 tty가 설정되어 있다면, tty를 통해 컨테이너에 접근할 수 있다. lxc-console 명령어를 통해 컨테이너에 접근할 수 있고 tty가 종료되었을 때 다시 로그인하지 않고 재접속 할 수 있다.



### 컨테이너 동결/ 동결해제

스케줄링 등을 위해 컨테이너에 속해있는 모든 프로세스를 정지 시키는 것은 유용할 수 있다. lxc-freeze로 컨테이너를 동결하여 모든 프로세스들을 인터럽트 불가상태로 만들거나 lxc-unfreeze로 컨테이너의 동결을 해제할 수 있다. 이 기능은 커널에서 cgroup freezer기능이 활성화 되어 있어야 가능하다.



#### 컨테이너 관련 정보 얻기

lxc-ls는 시스템의 컨테이너들의 리스트를 표시한다.

lxc-info는 지정한 컨테이너의 정보를 얻어온다.



#### 컨테이너 모니터링

컨테이너 상태를 모니터링하거나 스크립트에서 특정 상태를 기다리는 등 컨테이너의 상태를 추적하는 것은 유용하다.

lxc-monitor명령어는 하나 또는 여러개의 컨테이너들을 모니터링한다.

lxc-wait는 지정한 상태로 변화되는 것을 기다린다. 컨테이너의 시작이나 종료와 동기화되는 스크립트를 작성할 때 유용하다.



### 컨테이너 컨트롤 그룹 설정

컨테이너는 컨트롤 그룹과 결합되어있다. 컨테이너가 시작되면 컨트롤 그룹이 만들어지고 해당 컨트롤 그룹과 연결된다. 컨테이너가 실행 중일 때, lxc-cgroup 명령어를 이용해 컨트롤 그룹 속성을 읽거나 수정할 수 있다. 













1